<!DOCTYPE html>
<html>
<head>
    <title>Campaign Video Player</title>
    <style>
        body {
            margin: 0;
            background: black;
            font-family: Arial, sans-serif;
            color: white;
        }
        
        .video-container {
            position: relative;
            width: 100vw;
            height: 100vh;
            display: flex;
            align-items: center;
            justify-content: center;
        }
        
        .controls {
            position: absolute;
            top: 10px;
            right: 10px;
            z-index: 100;
        }
        
        .info-panel {
            position: absolute;
            top: 10px;
            left: 10px;
            z-index: 100;
            background: rgba(0,0,0,0.7);
            padding: 15px;
            border-radius: 8px;
            max-width: 300px;
        }
        
        .dashboard {
            position: absolute;
            bottom: 10px;
            left: 10px;
            right: 10px;
            background: rgba(0,0,0,0.8);
            padding: 15px;
            border-radius: 8px;
            display: none;
            max-height: 40vh;
            overflow-y: auto;
            z-index: 100;
        }
        
        .debug-panel {
            position: absolute;
            top: 50%;
            right: 10px;
            transform: translateY(-50%);
            background: rgba(0,0,0,0.8);
            padding: 15px;
            border-radius: 8px;
            display: none;
            max-width: 300px;
            z-index: 100;
        }
        
        button {
            padding: 10px 15px;
            background: #333;
            color: white;
            border: none;
            border-radius: 5px;
            cursor: pointer;
            margin: 5px;
        }
        
        button:hover {
            background: #555;
        }
        
        button:disabled {
            background: #666;
            cursor: not-allowed;
        }
        
        .campaign-item {
            background: rgba(255,255,255,0.1);
            margin: 5px 0;
            padding: 10px;
            border-radius: 4px;
            border-left: 4px solid transparent;
        }
        
        .campaign-active {
            border-left-color: #4CAF50;
        }
        
        .campaign-scheduled {
            border-left-color: #FF9800;
        }
        
        .campaign-inactive {
            border-left-color: #f44336;
        }
        
        .status-indicator {
            display: inline-block;
            width: 8px;
            height: 8px;
            border-radius: 50%;
            margin-right: 8px;
        }
        
        .status-active { background: #4CAF50; }
        .status-scheduled { background: #FF9800; }
        .status-inactive { background: #f44336; }
        .status-campaign { background: #2196F3; }
        .status-filler { background: #9E9E9E; }
        
        .stats {
            font-size: 12px;
            color: #ccc;
            margin-top: 5px;
        }
        
        .stats-row {
            display: flex;
            justify-content: space-between;
            margin: 2px 0;
        }
        
        #videoPlayer {
            max-width: 100%;
            max-height: 100%;
        }
        
        .toggle-btn {
            background: #2196F3;
        }
        
        .refresh-btn {
            background: #4CAF50;
        }
        
        .debug-btn {
            background: #9C27B0;
        }
        
        .error-message {
            color: #f44336;
            background: rgba(244, 67, 54, 0.1);
            padding: 10px;
            border-radius: 4px;
            margin: 10px 0;
        }
        
        .success-message {
            color: #4CAF50;
            background: rgba(76, 175, 80, 0.1);
            padding: 10px;
            border-radius: 4px;
            margin: 10px 0;
        }
        
        .warning-message {
            color: #FF9800;
            background: rgba(255, 152, 0, 0.1);
            padding: 10px;
            border-radius: 4px;
            margin: 10px 0;
        }
        
        .debug-info {
            font-size: 12px;
            color: #ccc;
            margin: 5px 0;
        }
        
        .campaign-details {
            font-size: 11px;
            color: #aaa;
            margin-top: 5px;
        }
        
        .no-video {
            color: #f44336;
            font-weight: bold;
        }
        
        .loading {
            display: flex;
            align-items: center;
            justify-content: center;
            height: 100vh;
            font-size: 18px;
        }
    </style>
</head>
<body>
    <div class="video-container">
        <!-- Control Panel -->
        <div class="controls">
            <button id="nextButton" onclick="skipVideo()">Next ▶</button>
            <button class="toggle-btn" onclick="toggleDashboard()">Dashboard</button>
            <button class="refresh-btn" onclick="refreshStatus()">Refresh</button>
            <button class="debug-btn" onclick="toggleDebug()">Debug</button>
        </div>

        <!-- Info Panel -->
        <div class="info-panel">
            <h3 style="margin-top:0;">Current Video</h3>
            <div id="videoInfo">
                <div>ID: <span id="videoID">Loading...</span></div>
                <div>Type: <span id="videoType"><span class="status-indicator"></span>Unknown</span></div>
                <div>File: <span id="videoFile">-</span></div>
                <div id="campaignInfo" style="display: none;">
                    <div>Campaign: <span id="campaignName">-</span></div>
                </div>
            </div>
            <div style="margin-top: 10px; font-size: 12px; color: #ccc;">
                <div>Time: <span id="currentTime">-</span></div>
                <div>Active Campaigns: <span id="activeCampaigns">-</span></div>
            </div>
            <div id="statusMessage"></div>
        </div>

        <!-- Video Player -->
        <video id="videoPlayer" width="100%" height="100%" autoplay muted></video>

        <!-- Dashboard -->
        <div class="dashboard" id="dashboard">
            <h3 style="margin-top:0;">Campaign Dashboard</h3>
            <div id="campaignList">
                <p>Loading campaigns...</p>
            </div>
        </div>

        <!-- Debug Panel -->
        <div class="debug-panel" id="debugPanel">
            <h3 style="margin-top:0;">Debug Info</h3>
            <div id="debugInfo">
                <p>Loading debug info...</p>
            </div>
        </div>
    </div>

    <script>
        const player = document.getElementById("videoPlayer");
        const nextButton = document.getElementById("nextButton");
        const dashboard = document.getElementById("dashboard");
        const debugPanel = document.getElementById("debugPanel");
        
        let dashboardVisible = false;
        let debugVisible = false;
        let statusUpdateInterval;
        let currentVideoInfo = null;
        let retryCount = 0;
        const maxRetries = 3;

        // Show status message
        function showStatus(message, type = 'success') {
            const statusEl = document.getElementById("statusMessage");
            const className = type === 'error' ? 'error-message' : 
                            type === 'warning' ? 'warning-message' : 'success-message';
            statusEl.innerHTML = `<div class="${className}">${message}</div>`;
            setTimeout(() => {
                statusEl.innerHTML = "";
            }, 5000);
        }

        // Load next video
        async function loadVideo(forceNext = false) {
            console.log("Loading next video...", forceNext ? "(forced next)" : "");
            nextButton.disabled = true;
            
            try {
                // Add timestamp to prevent caching and force parameter for manual skips
                const url = forceNext ? 
                    `/next-video?skip=true&_t=${Date.now()}` : 
                    `/next-video?_t=${Date.now()}`;
                
                const response = await fetch(url, {
                    method: 'GET',
                    headers: {
                        'Cache-Control': 'no-cache',
                        'Pragma': 'no-cache'
                    }
                });
                
                if (!response.ok) {
                    throw new Error(`HTTP error! status: ${response.status}`);
                }
                
                const blob = await response.blob();
                const videoUrl = URL.createObjectURL(blob);
                
                // Clean up previous URL
                if (player.src && player.src.startsWith('blob:')) {
                    URL.revokeObjectURL(player.src);
                }
                
                player.src = videoUrl;
                console.log("Video source set:", videoUrl, "Blob size:", blob.size);
                
                // Reset retry count on successful load
                retryCount = 0;
                
                // Wait for video to be ready, then play
                player.onloadeddata = () => {
                    console.log("Video loaded, attempting to play...");
                    player.play().then(() => {
                        console.log("Video playing successfully");
                        // Update video info after a short delay to ensure backend has processed the request
                        setTimeout(updateVideoInfo, 500);
                        showStatus(forceNext ? "Skipped to next video" : "Video loaded successfully");
                    }).catch(err => {
                        console.error("Error playing video:", err);
                        showStatus("Error playing video: " + err.message, 'error');
                    });
                };
                
                player.onerror = (e) => {
                    console.error("Video error:", e);
                    showStatus("Video error occurred", 'error');
                };
                
            } catch (error) {
                console.error("Error loading video:", error);
                showStatus("Error loading video: " + error.message, 'error');
                document.getElementById("videoID").textContent = "Error";
                document.getElementById("videoType").innerHTML = '<span class="status-indicator status-inactive"></span>Error';
                
                // Retry logic
                if (retryCount < maxRetries) {
                    retryCount++;
                    showStatus(`Retrying... (${retryCount}/${maxRetries})`, 'warning');
                    setTimeout(() => loadVideo(forceNext), 2000);
                }
            }
            
            nextButton.disabled = false;
        }

        // Skip to next video
        function skipVideo() {
            console.log("Skip video requested - forcing next video");
            retryCount = 0; // Reset retry count for manual skip
            
            // Stop current video immediately
            player.pause();
            
            // Force load next video with skip parameter
            loadVideo(true);
        }

        // Update video information
        async function updateVideoInfo() {
            try {
                console.log("Fetching current video info...");
                const response = await fetch("/api/current-video-id");
                
                if (!response.ok) {
                    console.error("Failed to fetch video info:", response.status, response.statusText);
                    
                    if (response.status === 404) {
                        // Handle 404 gracefully - might be startup issue
                        document.getElementById("videoID").textContent = "No video loaded";
                        document.getElementById("videoType").innerHTML = '<span class="status-indicator status-inactive"></span>Not loaded';
                        document.getElementById("videoFile").textContent = "-";
                        document.getElementById("campaignInfo").style.display = "none";
                        return;
                    }
                    
                    throw new Error(`HTTP error! status: ${response.status}`);
                }
                
                const data = await response.json();
                currentVideoInfo = data;
                console.log("Video info received:", data);

                document.getElementById("videoID").textContent = data.id || "unknown";
                document.getElementById("videoFile").textContent = data.filename || "-";
                
                const typeSpan = document.getElementById("videoType");
                const campaignInfo = document.getElementById("campaignInfo");
                
                if (data.type === "campaign") {
                    typeSpan.innerHTML = '<span class="status-indicator status-campaign"></span>Campaign';
                    if (data.campaign_name) {
                        document.getElementById("campaignName").textContent = data.campaign_name;
                        campaignInfo.style.display = "block";
                    } else {
                        campaignInfo.style.display = "none";
                    }
                } else {
                    typeSpan.innerHTML = '<span class="status-indicator status-filler"></span>Filler';
                    campaignInfo.style.display = "none";
                }
                
                // Show status info if available
                if (data.status) {
                    showStatus(data.status, 'warning');
                }
                
            } catch (err) {
                console.error("Failed to fetch video info:", err);
                document.getElementById("videoID").textContent = "error";
                document.getElementById("videoType").innerHTML = '<span class="status-indicator status-inactive"></span>Error';
                document.getElementById("campaignInfo").style.display = "none";
                showStatus("Failed to get video info: " + err.message, 'error');
            }
        }

        // Update campaign status
        async function updateCampaignStatus() {
            try {
                const response = await fetch("/api/campaign-status");
                const data = await response.json();
                
                // Update current time
                const time = new Date(data.current_time).toLocaleTimeString();
                document.getElementById("currentTime").textContent = time;
                
                // Update active campaigns count
                const activeCampaigns = data.active_count || 0;
                document.getElementById("activeCampaigns").textContent = activeCampaigns;
                
                // Update campaign dashboard
                updateCampaignDashboard(data.campaigns);
                
                // Update debug info
                updateDebugInfo(data);
                
            } catch (err) {
                console.error("Failed to fetch campaign status:", err);
                document.getElementById("activeCampaigns").textContent = "error";
                showStatus("Failed to get campaign status: " + err.message, 'error');
            }
        }

        // Update campaign dashboard
        function updateCampaignDashboard(campaigns) {
            const listEl = document.getElementById("campaignList");
            
            if (!campaigns || campaigns.length === 0) {
                listEl.innerHTML = "<p>No campaigns configured</p>";
                return;
            }
            
            let html = "";
            campaigns.forEach(campaign => {
                const status = campaign.status || 'inactive';
                const statusClass = `campaign-${status}`;
                const statusIndicator = `status-${status}`;
                
                // Format dates and times
                const startTime = campaign.start_time ? 
                    new Date(campaign.start_time).toLocaleDateString() : 'Not set';
                const endTime = campaign.end_time ? 
                    new Date(campaign.end_time).toLocaleDateString() : 'Not set';
                
                // Format time ranges
                const timeRanges = campaign.time_ranges && campaign.time_ranges.length > 0 ? 
                    campaign.time_ranges.join(', ') : 'All day';
                
                // Format days of week
                const daysOfWeek = campaign.days_of_week && campaign.days_of_week.length > 0 ? 
                    campaign.days_of_week.join(', ') : 'All days';
                
                // Video status
                const videoStatus = campaign.video_exists ? 
                    `✓ ${campaign.video_file}` : 
                    `✗ Missing: ${campaign.video_file || 'No file specified'}`;
                
                const videoClass = campaign.video_exists ? '' : 'no-video';
                
                html += `
                    <div class="campaign-item ${statusClass}">
                        <div><strong>${campaign.name || 'Unnamed Campaign'}</strong> 
                            <span class="status-indicator ${statusIndicator}"></span>
                            ${status.charAt(0).toUpperCase() + status.slice(1)}
                        </div>
                        <div class="stats">
                            <div class="stats-row">
                                <span>Videos:</span>
                                <span class="${videoClass}">${campaign.video_count || 0}</span>
                            </div>
                            <div class="stats-row">
                                <span>Start:</span>
                                <span>${startTime}</span>
                            </div>
                            <div class="stats-row">
                                <span>End:</span>
                                <span>${endTime}</span>
                            </div>
                            <div class="stats-row">
                                <span>Times:</span>
                                <span>${timeRanges}</span>
                            </div>
                            <div class="stats-row">
                                <span>Days:</span>
                                <span>${daysOfWeek}</span>
                            </div>
                            <div class="stats-row">
                                <span>Plays Today:</span>
                                <span>${campaign.plays_today || 0}</span>
                            </div>
                            <div class="stats-row">
                                <span>Plays This Hour:</span>
                                <span>${campaign.plays_this_hour || 0}</span>
                            </div>
                        </div>
                        <div class="campaign-details">
                            <div class="${videoClass}">${videoStatus}</div>
                            ${campaign.constraints ? 
                                `<div>Limits: ${campaign.constraints.plays_per_hour || '∞'}/hour, ${campaign.constraints.plays_per_day || '∞'}/day</div>` : 
                                ''
                            }
                        </div>
                    </div>
                `;
            });
            
            listEl.innerHTML = html;
        }

        // Update debug information
        function updateDebugInfo(data) {
            const debugEl = document.getElementById("debugInfo");
            
            let html = "<div class='debug-info'>";
            html += `<div><strong>System Status:</strong></div>`;
            html += `<div>Server Time: ${new Date(data.current_time).toLocaleString()}</div>`;
            html += `<div>Total Campaigns: ${data.total_campaigns || 0}</div>`;
            html += `<div>Active: ${data.active_count || 0}</div>`;
            html += `<div>Scheduled: ${data.scheduled_count || 0}</div>`;
            html += `<div>Inactive: ${data.inactive_count || 0}</div>`;
            
            if (currentVideoInfo) {
                html += `<div style="margin-top: 10px;"><strong>Current Video:</strong></div>`;
                html += `<div>ID: ${currentVideoInfo.id}</div>`;
                html += `<div>Type: ${currentVideoInfo.type}</div>`;
                html += `<div>File: ${currentVideoInfo.filename || 'N/A'}</div>`;
                if (currentVideoInfo.campaign_name) {
                    html += `<div>Campaign: ${currentVideoInfo.campaign_name}</div>`;
                }
            }
            
            if (data.current_video_info) {
                html += `<div style="margin-top: 10px;"><strong>Backend Current Video:</strong></div>`;
                html += `<div>Path: ${data.current_video_info.path || 'None'}</div>`;
                html += `<div>Type: ${data.current_video_info.type || 'None'}</div>`;
                html += `<div>File: ${data.current_video_info.filename || 'None'}</div>`;
            }
            
            html += "</div>";
            debugEl.innerHTML = html;
        }

        // Toggle dashboard visibility
        function toggleDashboard() {
            dashboardVisible = !dashboardVisible;
            dashboard.style.display = dashboardVisible ? "block" : "none";
            
            if (dashboardVisible) {
                updateCampaignStatus(); // Refresh when showing
            }
        }

        // Toggle debug panel visibility
        function toggleDebug() {
            debugVisible = !debugVisible;
            debugPanel.style.display = debugVisible ? "block" : "none";
            
            if (debugVisible) {
                updateCampaignStatus(); // Refresh when showing
            }
        }

        // Refresh all status information
        function refreshStatus() {
            console.log("Refreshing status...");
            updateVideoInfo();
            updateCampaignStatus();
            showStatus("Status refreshed");
        }

        // Handle video end - auto-load next video
        player.addEventListener('ended', () => {
            console.log("Video ended, loading next...");
            setTimeout(() => loadVideo(false), 1000); // Small delay before loading next, don't force skip
        });

        // Handle player errors
        player.addEventListener('error', (e) => {
            console.error("Player error:", e);
            showStatus("Video playback error", 'error');
        });

        // Keyboard shortcuts
        document.addEventListener('keydown', (e) => {
            switch(e.key) {
                case ' ':
                case 'Enter':
                    e.preventDefault();
                    skipVideo();
                    break;
                case 'd':
                case 'D':
                    toggleDashboard();
                    break;
                case 'g':
                case 'G':
                    toggleDebug();
                    break;
                case 'r':
                case 'R':
                    refreshStatus();
                    break;
            }
        });

        // Initialize on page load
        window.addEventListener('load', () => {
            console.log("Page loaded, initializing...");
            
            // Initial load (not a skip)
            loadVideo(false);
            updateCampaignStatus();
            
            // Set up periodic status updates (every 30 seconds)
            statusUpdateInterval = setInterval(() => {
                updateCampaignStatus();
                // Also update video info periodically in case backend state changed
                updateVideoInfo();
            }, 30000);
        });

        // Cleanup on page unload
        window.addEventListener('beforeunload', () => {
            if (statusUpdateInterval) {
                clearInterval(statusUpdateInterval);
            }
            
            // Clean up blob URLs
            if (player.src && player.src.startsWith('blob:')) {
                URL.revokeObjectURL(player.src);
            }
        });

        // Add some visual feedback for button interactions
        document.querySelectorAll('button').forEach(button => {
            button.addEventListener('click', function() {
                this.style.transform = 'scale(0.95)';
                setTimeout(() => {
                    this.style.transform = 'scale(1)';
                }, 100);
            });
        });

        console.log("Campaign Video Player initialized");
    </script>
</body>
</html>